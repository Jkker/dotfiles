{{ if eq .chezmoi.os "linux" -}}
#!/bin/bash
set -e

# --- OS & Environment Detection ---
IS_SERVER=false
if [ -z "$DISPLAY" ] && [ -z "$WAYLAND_DISPLAY" ]; then
	IS_SERVER=true
fi
if [[ "$(uname -a)" == *"Ubuntu"* && "$(lsb_release -d)" == *"Server"* ]]; then
	IS_SERVER=true
fi

IS_WSL=false
if command -v wslinfo >/dev/null 2>&1 || [[ -n "$WSL_DISTRO_NAME" ]]; then
	IS_WSL=true
fi

# --- Helpers ---
log_info() { echo -e "\033[0;34m[INFO]\033[0m $(date +'%Y-%m-%dT%H:%M:%S%z') $1"; }
log_warn() { echo -e "\033[0;33m[WARN]\033[0m $(date +'%Y-%m-%dT%H:%M:%S%z') $1"; }
log_error() { echo -e "\033[0;31m[ERROR]\033[0m $(date +'%Y-%m-%dT%H:%M:%S%z') $1"; }
log_success() { echo -e "\033[0;32m[SUCCESS]\033[0m $(date +'%Y-%m-%dT%H:%M:%S%z') $1"; }

# --- 1. Base Setup ---
export DEBIAN_FRONTEND=noninteractive

# --- WSL Specific Setup ---
if [ "$IS_WSL" = true ]; then
	echo "WSL: Configuring passwordless sudo for $(whoami)..."
	echo "$(whoami) ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/$(whoami) && sudo chmod 0440 /etc/sudoers.d/$(whoami)
fi

sudo apt-get update -qq
sudo apt-get upgrade -y -qq

# --- Package Installation ---
PKG_LIST=(
	"build-essential"
	"curl"
	"ca-certificates"
	"unattended-upgrades"
	"apt-listchanges"
	"apt-transport-https"
	"lsb-release"
	"gnupg"
	"ffmpeg"
	"git"
	"graphviz"
	"htop"
	"imagemagick"
	"nmap"
	"sqlite3"
	"tesseract-ocr"
	"unzip"
	"wget"
	"zip"
	"zsh"
)

echo "Installing APT packages..."
sudo apt-get install -y -qq "${PKG_LIST[@]}"

# --- Shell Setup ---
CURRENT_SHELL_PATH=$(getent passwd "$USER" | cut -d: -f7 2>/dev/null || echo $SHELL)
TARGET_SHELL_PATH=$(command -v zsh)

if [ -n "$TARGET_SHELL_PATH" ] && [ "$CURRENT_SHELL_PATH" != "$TARGET_SHELL_PATH" ]; then
	log_info "Changing default shell to zsh..."
	if sudo -n true 2>/dev/null; then
		sudo chsh -s "$TARGET_SHELL_PATH" "$USER" || log_warn "Failed to change shell. Try: chsh -s $TARGET_SHELL_PATH"
	else
		# Try without sudo
		chsh -s "$TARGET_SHELL_PATH" || log_warn "Failed to change shell. Try manually: chsh -s $TARGET_SHELL_PATH"
	fi
fi

# Security: Unattended Upgrades
log_info "Configuring Unattended Upgrades..."
cat <<EOF | sudo tee /etc/apt/apt.conf.d/51unattended-upgrades-local >/dev/null
Unattended-Upgrade::Allowed-Origins {
    "\\\${distro_id}:\\\${distro_codename}";
    "\\\${distro_id}:\\\${distro_codename}-security";
    "\\\${distro_id}ESMApps:\\\${distro_codename}-apps-security";
    "\\\${distro_id}ESM:\\\${distro_codename}-infra-security";
};
Unattended-Upgrade::Package-Blacklist {};
Unattended-Upgrade::Automatic-Reboot "false";
Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";
EOF
sudo systemctl enable --now unattended-upgrades

# --- Server Specific Packages ---
if [ "$IS_SERVER" = true ]; then
	if ! command -v docker &>/dev/null; then
		echo "Installing Docker..."
		# https://docs.docker.com/engine/install/ubuntu/
		sudo install -m 0755 -d /etc/apt/keyrings
		sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
		sudo chmod a+r /etc/apt/keyrings/docker.asc

		# Add the repository to Apt sources:
		sudo tee /etc/apt/sources.list.d/docker.sources <<EOF
Types: deb
URIs: https://download.docker.com/linux/ubuntu
Suites: $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}")
Components: stable
Signed-By: /etc/apt/keyrings/docker.asc
EOF
		sudo apt-get update -qq
		sudo apt-get install -y -qq docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

		echo "Adding $(whoami) to docker group..."
		sudo groupadd docker || true
		sudo usermod -aG docker "$USER" || true
		newgrp docker || true
	fi
fi

sudo apt-get autoremove -y -qq
sudo apt-get clean
log_success "System packages are up to date."

# --- Mise Setup ---
export MISE_GLOBAL_CONFIG_FILE="$HOME/.config/mise/config.toml"

if ! command -v mise &>/dev/null; then
	echo "Installing Mise..."
	curl https://mise.run | sh
	export PATH="$HOME/.local/bin:$PATH"
fi

if command -v mise &>/dev/null; then
	# Ensure Mise is loaded for this session
	eval "$(mise activate bash)"
	MISE_BIN="$(command -v mise)"

	echo "Running Mise Install..."
	if [ -f "$MISE_GLOBAL_CONFIG_FILE" ]; then
		mise trust "$MISE_GLOBAL_CONFIG_FILE"
	fi
	mise install

	echo "Configuring system-wide access for mise..."
	# 1. Symlink mise binary to /usr/local/bin
	if [ -n "$MISE_BIN" ] && [ "$MISE_BIN" != "/usr/local/bin/mise" ]; then
		sudo ln -sf "$MISE_BIN" /usr/local/bin/mise
	fi

	# 2. Add the output of `mise activate bash --shims` to sudo secure_path
	if [ -n "$MISE_BIN" ]; then
		SHIM_PATH=$("$MISE_BIN" activate bash --shims | sed -e 's/^export PATH=\"//' -e 's/:$PATH"$//')
	fi

	if [ -n "$SHIM_PATH" ]; then
		echo "Adding $SHIM_PATH to sudo secure_path..."

		# Standard Ubuntu secure_path with the shim path appended
		SECURE_PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin:$SHIM_PATH"

		# Create the sudoers configuration file
		echo "Defaults secure_path=\"$SECURE_PATH\"" | sudo tee /etc/sudoers.d/mise-shims >/dev/null

		# Set correct permissions (440 is required for sudoers files)
		sudo chmod 440 /etc/sudoers.d/mise-shims
	fi
else
	log_error "Mise binary not found after installation attempt."
fi

echo "Setup complete."

{{ else if eq .chezmoi.os "darwin" -}}
#!/bin/bash
set -e

# --- Homebrew Setup ---
if ! command -v brew &>/dev/null; then
	echo "Installing Homebrew..."
	/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

# --- Brew Bundle ---
echo "Installing Brew packages..."
brew bundle --no-lock --file=/dev/stdin <<EOF
brew "curl"
brew "ffmpeg"
brew "git"
brew "graphviz"
brew "htop"
brew "imagemagick"
brew "nmap"
brew "sqlite"
brew "tesseract"
brew "wget"
brew "zsh"
EOF

# --- Mise Setup ---
if ! command -v mise &>/dev/null; then
	echo "Installing Mise..."
	curl https://mise.run | sh
fi
export PATH="$HOME/.local/bin:$PATH"
mise install

{{ else if eq .chezmoi.os "windows" -}}
echo "Windows setup: Ensure Mise is installed."
winget install jdx.mise
mise install
{{ end -}}

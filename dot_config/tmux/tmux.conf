# ============================================================================
# TMUX CONFIGURATION
# Optimized for SSH from mobile terminals (Termius/Android)
# ============================================================================

# ============================================================================
# SECTION 1: TERMINAL & TRUE COLOR SUPPORT
# ============================================================================
# Set default terminal type for proper color/feature support
# "tmux-256color" provides the best compatibility with modern terminals
set -g default-terminal "tmux-256color"

# Enable true color (24-bit RGB) for terminals that support it
# - First override: any terminal with "256col" in name
# - Second override: any xterm-based terminal
# The ":Tc" flag enables true color support
set -ga terminal-overrides ",*256col*:Tc"
set -ga terminal-overrides ",xterm*:Tc"

# ============================================================================
# SECTION 2: MOUSE & SCROLLING (Critical for mobile SSH)
# ============================================================================
# Enable mouse support globally - required for any mouse/touch interaction
set -g mouse on

# Scrollback buffer - 50k lines should be plenty for most use cases
set -g history-limit 50000

# ---------------------------------------------------------------------------
# SCROLLING FIX FOR TERMIUS/ANDROID
# ---------------------------------------------------------------------------
# Problem: Termius converts touch swipes to mouse wheel events, but tmux's
# default behavior doesn't always enter copy-mode automatically.
#
# Solution: Explicitly handle WheelUp/WheelDown to:
# 1. Auto-enter copy-mode when scrolling up at the prompt
# 2. Pass through wheel events to apps that handle their own scrolling
#
# The key variable is #{mouse_any_flag} which is true when the underlying
# application (vim, less, etc.) has requested mouse events.
# ---------------------------------------------------------------------------

# WheelUpPane: When scrolling up...
# - If app wants mouse events (vim, less, etc.): pass through (-M)
# - Else if already in copy-mode: pass through to scroll history
# - Else: enter copy-mode with -e (exit on scroll-to-bottom) and scroll
bind -n WheelUpPane \
    if-shell -F "#{mouse_any_flag}" \
        "send-keys -M" \
        "if-shell -F '#{pane_in_mode}' 'send-keys -M' 'copy-mode -e; send-keys -M'"

# WheelDownPane: When scrolling down...
# - Always select the pane first (for multi-pane layouts)
# - Then pass through the scroll event
bind -n WheelDownPane select-pane -t= \; send-keys -M

# Copy-mode scrolling: Scroll 3 lines per wheel tick for faster navigation
# This makes scrolling through long outputs much faster on mobile
bind -T copy-mode-vi WheelUpPane   send-keys -X -N 3 scroll-up
bind -T copy-mode-vi WheelDownPane send-keys -X -N 3 scroll-down

# ---------------------------------------------------------------------------
# ALTERNATIVE SCROLL METHOD (Backup)
# ---------------------------------------------------------------------------
# If wheel events still don't work, PageUp/PageDown always work reliably
# These enter copy-mode if not already in it
bind -n PageUp   if-shell -F "#{pane_in_mode}" "send-keys -X page-up"   "copy-mode -eu"
bind -n PageDown if-shell -F "#{pane_in_mode}" "send-keys -X page-down" ""

# ============================================================================
# SECTION 3: GENERAL TERMINAL BEHAVIOR
# ============================================================================
# Enable xterm-style function key sequences for better key compatibility
set -g xterm-keys on

# Enable OSC 52 clipboard integration (copy to system clipboard via terminal)
# This allows copying from tmux to reach Android's clipboard through Termius
set -g set-clipboard on

# Track focus events - allows vim/neovim to detect when you switch windows
set -g focus-events on

# Don't constrain window size to smallest client viewing that window
# Only constrain to smallest client actively viewing that specific session
set -g aggressive-resize on

# ============================================================================
# SECTION 4: COPY MODE (Vi-style)
# ============================================================================
# Use vi-style navigation in copy mode
set -g mode-keys vi

# Visual styling for search matches in copy mode
set -g copy-mode-match-style "bg=yellow,fg=black"         # Regular matches
set -g copy-mode-current-match-style "bg=green,fg=black"  # Current match
set -g copy-mode-mark-style "bg=red,fg=white"             # Mark position

# Vi-style selection and yanking
bind -T copy-mode-vi v      send-keys -X begin-selection
bind -T copy-mode-vi y      send-keys -X copy-selection-and-cancel
bind -T copy-mode-vi Escape send-keys -X clear-selection
bind -T copy-mode-vi H      send-keys -X start-of-line
bind -T copy-mode-vi L      send-keys -X end-of-line

# Rectangle (block) selection with Ctrl+v
bind -T copy-mode-vi C-v    send-keys -X rectangle-toggle

# Quick copy mode access
# Ctrl+w: Enter copy mode (mnemonic: "watch" scrollback)
# Ctrl+e: Paste buffer (mnemonic: "emit" buffer)
bind -n C-w copy-mode
bind -n C-e paste-buffer

# ============================================================================
# SECTION 5: NOTIFICATIONS (Silent mode for mobile)
# ============================================================================
# Disable all bells and visual notifications
# Mobile SSH sessions don't benefit from these and they can be annoying
set -g monitor-silence 0
set -g visual-silence off
set -g visual-bell off
set -g visual-activity off

# ============================================================================
# SECTION 6: PREFIX KEY & BASIC BINDINGS
# ============================================================================
# Change prefix from Ctrl+b to Ctrl+Space (easier to reach)
unbind C-b
set -g prefix C-Space
bind C-Space send-prefix

# Window/pane numbering starts at 1 (matches keyboard layout)
set -g base-index 1
set -g pane-base-index 1
set-window-option -g pane-base-index 1

# Auto-renumber windows when one is closed
set-option -g renumber-windows on

# ============================================================================
# SECTION 7: PANE & WINDOW NAVIGATION
# ============================================================================
# Alt+Arrow: Switch between panes (no prefix needed)
bind -n M-Left  select-pane -L
bind -n M-Right select-pane -R
bind -n M-Up    select-pane -U
bind -n M-Down  select-pane -D

# Shift+Arrow: Switch between windows (no prefix needed)
bind -n S-Left  previous-window
bind -n S-Right next-window

# Split panes in current directory
bind '"' split-window -v -c "#{pane_current_path}"
bind %   split-window -h -c "#{pane_current_path}"

# ============================================================================
# SECTION 8: MOBILE-FRIENDLY BINDINGS
# ============================================================================
# Function keys for quick access (useful when Ctrl combos are unreliable)
# F1: Enter copy mode (same as Ctrl+w)
# F2: Paste buffer (same as Ctrl+e)
# F3: Next window
# F4: Previous window
bind -n F1 copy-mode
bind -n F2 paste-buffer
bind -n F3 next-window
bind -n F4 previous-window

# ============================================================================
# SECTION 9: STATUS BAR & APPEARANCE
# ============================================================================
# Position status bar at top (easier to see on mobile with keyboard open)
set -g status-position top

# Pane border colors
set -g pane-active-border-style "fg=green"
set -g pane-border-style "fg=colour240"

# Pane number display (when pressing prefix+q)
set -g display-panes-colour blue
set -g display-panes-active-colour red
set -g display-panes-time 2000

# ============================================================================
# SECTION 10: TIMING & PERFORMANCE
# ============================================================================
# How long status messages are displayed (5 seconds)
set -g display-time 5000

# Time window for repeat key presses without prefix (800ms)
set -g repeat-time 800

# Status bar refresh interval (every 5 seconds to save battery on mobile)
set -g status-interval 5

# ============================================================================
# SECTION 11: PLUGINS (via TPM)
# ============================================================================
# TPM - Tmux Plugin Manager
set -g @plugin 'tmux-plugins/tpm'

# Sensible defaults everyone can agree on
set -g @plugin 'tmux-plugins/tmux-sensible'

# Catppuccin theme (dreamsofcode fork for better compatibility)
set -g @plugin 'dreamsofcode-io/catppuccin-tmux'

# Enhanced yank/copy with system clipboard support
set -g @plugin 'tmux-plugins/tmux-yank'

# Context menus (right-click or prefix+\)
set -g @plugin 'jaclu/tmux-menus'

# Session persistence across restarts
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'

# Fuzzy finder integration
set -g @plugin 'sainnhe/tmux-fzf'

# ---------------------------------------------------------------------------
# Plugin Configuration
# ---------------------------------------------------------------------------
# Catppuccin: Minimal status bar for mobile (hide clutter)
set -g @catppuccin_status_modules_right ""
set -g @catppuccin_status_modules_left ""
set -g @catppuccin_window_default_text "#W"
set -g @catppuccin_window_current_text "#W"

# Continuum: Auto-restore sessions on tmux start
set -g @continuum-restore 'on'

# ---------------------------------------------------------------------------
# tmux-fzf Bindings (no prefix required)
# ---------------------------------------------------------------------------
# Ctrl+F: Open fzf menu
bind -n C-F run-shell -b "$HOME/.config/tmux/plugins/tmux-fzf/main.sh"

# Ctrl+S: Quick window switcher via fzf
bind -n C-S run-shell -b "$HOME/.config/tmux/plugins/tmux-fzf/scripts/window.sh switch"

# ============================================================================
# SECTION 12: INITIALIZE TPM
# ============================================================================
# IMPORTANT: This must be at the very end of the config file
run '~/.tmux/plugins/tpm/tpm'

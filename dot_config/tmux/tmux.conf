# ============================================================================
# TMUX CONFIGURATION
# Optimized for native scrolling on mobile SSH (Termius/Android)
# ============================================================================

# ============================================================================
# SECTION 1: TERMINAL & TRUE COLOR
# ============================================================================
# Terminal type - tmux-256color for best compatibility
set -g default-terminal "tmux-256color"

# True color (24-bit) support for modern terminals
set -ga terminal-overrides ",*256col*:Tc"
set -ga terminal-overrides ",xterm*:Tc"

# ============================================================================
# SECTION 2: NATIVE SCROLLING (The key fix for Termius)
# ============================================================================
# WHAT THIS DOES:
# Terminals use two screen modes:
#   1. Normal mode: scrollback works, output accumulates
#   2. Alternate mode: fullscreen apps (vim, less), no scrollback
#
# smcup = "start mouse cursor addressing" (enter alternate screen)
# rmcup = "restore mouse cursor addressing" (exit alternate screen)
#
# By disabling these (smcup@:rmcup@), tmux never switches to alternate mode.
# This means Termius handles ALL scrolling natively - swipes just work.
#
# TRADEOFF: Fullscreen apps (vim, htop, less) will leave "garbage" on screen
# when they exit because they can't restore the previous screen content.
# This is purely cosmetic - just hit Enter or run 'clear' to clean up.
# ============================================================================
set -ga terminal-overrides ",*:smcup@:rmcup@"

# Enable mouse (still needed for clicking panes, resizing, etc.)
set -g mouse on

# Large scrollback buffer (Termius will handle the actual scrolling)
set -g history-limit 50000

# ============================================================================
# SECTION 3: GENERAL TERMINAL BEHAVIOR
# ============================================================================
# xterm-style function keys for better keyboard compatibility
set -g xterm-keys on

# OSC 52 clipboard - allows copying to reach Android clipboard via Termius
set -g set-clipboard on

# Focus events - lets vim/neovim know when you switch away
set -g focus-events on

# Only constrain to smallest client on THIS session, not all sessions
set -g aggressive-resize on

# ============================================================================
# SECTION 4: COPY MODE (Vi-style)
# ============================================================================
# NOTE: With native scrolling enabled, you rarely need copy-mode for scrolling.
# It's still useful for text selection and searching within scrollback.

set -g mode-keys vi

# Search match highlighting
set -g copy-mode-match-style "bg=yellow,fg=black"
set -g copy-mode-current-match-style "bg=green,fg=black"
set -g copy-mode-mark-style "bg=red,fg=white"

# Vi-style selection bindings
bind -T copy-mode-vi v      send-keys -X begin-selection
bind -T copy-mode-vi y      send-keys -X copy-selection-and-cancel
bind -T copy-mode-vi Escape send-keys -X clear-selection
bind -T copy-mode-vi H      send-keys -X start-of-line
bind -T copy-mode-vi L      send-keys -X end-of-line
bind -T copy-mode-vi C-v    send-keys -X rectangle-toggle

# Manual copy-mode access (for searching/selecting, not scrolling)
# Prefix + [ is the default, these are extras
bind -n C-w copy-mode
bind -n C-e paste-buffer

# ============================================================================
# SECTION 5: SILENCE NOTIFICATIONS
# ============================================================================
# Disable all bells/alerts - not useful on mobile
set -g monitor-silence 0
set -g visual-silence off
set -g visual-bell off
set -g visual-activity off

# ============================================================================
# SECTION 6: PREFIX & BASIC BINDINGS
# ============================================================================
# Prefix: Ctrl+Space (easier than Ctrl+b)
unbind C-b
set -g prefix C-Space
bind C-Space send-prefix

# Start numbering at 1 (matches keyboard layout 1-9)
set -g base-index 1
set -g pane-base-index 1
set-window-option -g pane-base-index 1
set-option -g renumber-windows on

# ============================================================================
# SECTION 7: NAVIGATION
# ============================================================================
# Alt+Arrow: Switch panes (no prefix)
bind -n M-Left  select-pane -L
bind -n M-Right select-pane -R
bind -n M-Up    select-pane -U
bind -n M-Down  select-pane -D

# Shift+Arrow: Switch windows (no prefix)
bind -n S-Left  previous-window
bind -n S-Right next-window

# Split in current directory
bind '"' split-window -v -c "#{pane_current_path}"
bind %   split-window -h -c "#{pane_current_path}"

# ============================================================================
# SECTION 8: MOBILE-FRIENDLY BINDINGS
# ============================================================================
# Function keys as backup (if Ctrl combos don't work on Termius keyboard)
bind -n F1 copy-mode
bind -n F2 paste-buffer
bind -n F3 next-window
bind -n F4 previous-window

# ============================================================================
# SECTION 9: APPEARANCE
# ============================================================================
# Status bar at top (visible with mobile keyboard open)
set -g status-position top

# Pane borders
set -g pane-active-border-style "fg=green"
set -g pane-border-style "fg=colour240"

# Pane number display (prefix+q)
set -g display-panes-colour blue
set -g display-panes-active-colour red
set -g display-panes-time 2000

# ============================================================================
# SECTION 10: TIMING
# ============================================================================
set -g display-time 5000      # Status messages visible for 5s
set -g repeat-time 800        # 800ms window for repeat keys
set -g status-interval 5      # Refresh status every 5s (saves battery)

# ============================================================================
# SECTION 11: PLUGINS
# ============================================================================
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'dreamsofcode-io/catppuccin-tmux'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'jaclu/tmux-menus'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'sainnhe/tmux-fzf'

# -- Plugin Config --
# Minimal status bar (more space for window tabs)
set -g @catppuccin_status_modules_right ""
set -g @catppuccin_status_modules_left ""
set -g @catppuccin_window_default_text "#W"
set -g @catppuccin_window_current_text "#W"

# Auto-restore sessions
set -g @continuum-restore 'on'

# -- tmux-fzf (no prefix) --
bind -n C-F run-shell -b "$HOME/.config/tmux/plugins/tmux-fzf/main.sh"
bind -n C-S run-shell -b "$HOME/.config/tmux/plugins/tmux-fzf/scripts/window.sh switch"

# ============================================================================
# SECTION 12: INIT TPM (must be last)
# ============================================================================
run '~/.tmux/plugins/tpm/tpm'
